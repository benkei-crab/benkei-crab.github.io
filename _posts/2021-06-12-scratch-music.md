---
layout: post
title:  "Music Player 1"
date:   2021-06-12 12:16:00 +0900
categories: Scratch Music
---

# Music Player

## はじめに
ここではScratchで曲を演奏するプログラムを作ります。メロディーだけを演奏するプログラムから始めて、伴奏を付けたり、調を変えたりできるように追加、改良して行こうと思います。さらに、曲を選んで演奏できるようにしてみましょう。どうぞお付き合いください。

曲は、(ほぼ)誰もが知っているであろう「きらきら星」を例に作ります。もしあなたのお気に入りの曲が別にあればそれを代わりに使ってください。以下に「きらきら星」の楽譜をしめします(MuseScore 3というソフトウェアで書きました。無料でダウンロードして使えるので興味があったら試してみてください)。

<img src="/assets/images/twinkle01.png" alt="Score_for_twinkle_twinkle_little_star" width="800" height="640">

### 逐次処理
上に示した「きらきら星」の楽譜は、音の高さ、音の長さを持つ音符を左から順番に演奏することを指示する「プログラム」と言えます(通常このプログラムを解釈するのは計算機ではなく人間ですが)。こうしたプログラムを逐次処理(serial processing)プログラムと呼びます。

一方、楽譜には順番に演奏する逐次処理だけでなく、例えば和音を鳴らしたり、メロディーに伴奏を付けたりと、同時に処理すべき命令も出てきます。このような処理を並列処理i(parallel processing)と呼びます。Scratchでは、いくつかの方法で並列処理を行うこともできます(実際には「並列処理しているように見せることもできます」が正確な表現だと思いますが、ここでは並列処理で統一します)。後でメロディーに伴奏を付けるところで並列処理も使うのでお楽しみに!

さて、話が先走り過ぎたので、逐次処理に話を戻します。
Scratchでは、スプライト(初期画面ではネコの画像のアレです)という単位ごとにブロックを並べた順に命令が逐次処理されます。他の多くの言語で命令を並べた順に処理されるのと同じです。
ここでは音を鳴らすブロックを繋げて順番に実行させることで曲を演奏するプログラムを作ってみましょう。以下のように一緒に作ってみてください。


1. 音楽ブロックのロード
音楽ブロックは拡張機能なので、まず音楽ブロックをロードする必要があります。
コードタブで一番左の〇ブロックの一番下にブロックに+マークのアイコンがあります。このアイコンをクリックすると、拡張機能の選択画面が表示されます。
「音楽」をクリックしましょう。
すると、ブロックリストの下に新しく音楽(音符のアイコン)が増え、音楽のコードブロック(緑)が追加されます。

1. 「楽器を()にする」ブロックをコードエリアにドラッグ&ドロップします。初期状態では()内は「(1)ピアノ」です。クリックすると好きな楽器に変えることができます。ここでの説明はピアノのままですが、お好みの楽器に変えた場合は、楽器名を読み替えてください。
1. 「(60)の音符を(0.25)拍鳴らす」ブロック
<img src="/assets/images/note01.png" alt="note: pitch 60 beat 0.25" width="122" height="25">
をコードエリアにドラッグして、「楽器を((1)ピアノ)にする」ブロックの下につなげてください。つなげたい場所の近くにブロックをドラッグし灰色でブロックの影が示されたら、ドロップすると影の場所にドロップしたブロックがつながります。
1. つながったブロックのどこかをクリックしてみましょう。60(ドの音)が鳴りましたか?Scratchでは音の高さを数字で表します。
1. (60)の部分をクリックしてみると、ピアノの鍵盤の一部が表示され、C(60)と表示されます(先ほどクリックしたときに(60)の部分をクリックしてしまった人はびっくりしたかもしれません)。鍵盤上で好きな音を選んで、クリックしてみましょう。ブロックの表示が選んだ音に変わりましたか?これで音の高さの変え方がわかりました。ド・レ・ミ・ファ・ソ・ラ・シ・ドはそれぞれ60, 62, 64, 65, 67, 69, 71, 72です。半音ごとに数字が振られているわけですね。
1. ()拍鳴らすのカッコ内を変えると音の長さが変わります。ここで音の長さを色々変えても良いのですが、曲全体の早さはテンポで変えるのが便利です。「テンポを(60)にする」ブロックです。このブロックは()内の数値 拍/分(beat per minute; bpm)のテンポでの演奏を指示します。色々な数字を試して、好みのテンポを見つけてみましょう。ブロックパレットから「テンポを(60)にする」ブロックをドラッグして「楽器を()にする」ブロックの下に付けてください。テンポを変えると音の長さが変わることを確認できたら、「()の音符を()拍鳴らす」ブロックの()拍には楽譜通りの音符の長さを入れましょう。「きらきら星」は4/4拍子なのでここでは四分音符を1とします。
1. では、用意したきらきら星の楽譜の通りに入力しましょう。長いと大変なので、最初の方だけ入力したら演奏してみるのがおすすめです。つなげたブロックのどこかをクリックすれば一番上から演奏が始まり、順番に一番下まで演奏されます。入力時に二分音符は四分音符の2倍の長さなので、(2)拍にするのを忘れないようにしましょう。
1. 全体を入力できたら演奏してみましょう。作品として他の人に使ってもらうには、緑の旗やスプライトを押したら演奏が始まるようにするとよいでしょう。これらはイベントカテゴリーにあります。ブロックパレットの「イベント」をクリックしてイベントカテゴリーのブロックを表示し、「緑の旗が押されたとき」ブロック
<img src="/assets/images/green_flag01.png" alt="note: pitch 60 beat 0.25" width="80" height="37">
を演奏プログラムの先頭にドラッグ＆ドロップします。あるいは、イベントカテゴリの他のブロックを使っても良いですね。例えば、「このスプライトが押されたとき」ブロックを先ほどの緑の旗が押されたときブロックと交換してみましょう。今度は、画面上の猫をクリックすると、演奏が始まります。イベントブロックを使うと、マウスクリックなど何かを受け取ったとき(もうわかったと思いますが、こういうのをイベントと呼びます)、そのイベントに応答するプログラムを作ることができます。以下では、「緑の旗」をクリックしてプログラムを開始することにします。

これで「きらきら星」を演奏できるようになったので、これからこのプログラムをいじって少し遊んでみようと思います。
その前に準備として、プログラムを整理して見通しをよくしておきたいと思います。

### 名前付け(ラベル)による抽象化
このプログラムは「()の音符を()拍鳴らす」ブロックが並ぶだけの簡単なものですが、ブロック数が多いためどこかを変えようと思っても該当する場所を探すのもなかなか大変です。そこで、複数のブロックをまとまりごとに名前を付けて扱いやすくしましょう。
まずは、楽譜を見てまとまりを探してみましょう。この曲は4/4拍子なので、四分音符4つ分、つまり4個の(1)拍鳴らすブロックで1小節という1つのまとまりです。そこで4拍ずつブロックを区切ってみましょう。
ここではドレミで書いてみます。

1. ドドソソ
2. ララソ->ソが2拍
3. ファファミミ
4. レレド
5. ソソファファ
6. ミミレ
7. ソソファファ
8. ミミレ
9. ドドソソ
10. ララソ
11. ファファミミ
12. レレド

すぐ気づくのは、1と9、2と10、3と11、4と12が同じで、5と7、6と8も同じだということですね。もう少し大きく見ると、1-4と9-12が同じで、5-6と7-8も同じとわかります。
したがって、この曲は、上の小節番号をもちいて、

1, 2, 3, 4, 
5, 6, 
5, 6, 
1, 2, 3, 4

と表せることがわかります。小節番号だとわかりにくいので、歌詞を使って名前を付けてみましょう。

きらきら, ひかる, おそらの, ほしよ, 
まばたき, しては, 
まばたき, しては, 
きらきら, ひかる, おそらの, ほしよ

さらに繰返し単位をまとめて、出だしの歌詞と含まれる小節数で名前を付け直すと

1. きらきら4
2. まばたき2
3. まばたき2
4. きらきら4

です。
こう書いてあれば一目で曲の繰り返し構造がわかりますね。最初の「()の音符を()拍鳴らす」ブロックの羅列と比べてみてください。

#### 定義ブロックによるブロックのまとまりへの名前付け
では、同じことをScratchでもやってみましょう。
一番左の一番下にある「音楽」カテゴリの一つ上に、「ブロック定義」カテゴリがあります。アイコンをクリックしてみましょう。このカテゴリには「ブロックを定義する」というボタンが一つだけあると思います。このボタンを押すと「ブロック定義」というダイアログが開きます。ピンク色のブロックの中の「ブロックの名前」と書かれたテキストエリアに、先ほどの「きらきら4」と入力してOKしてみてください。
コードエリアに新しい(頭の丸い)ブロックが現われたはずです。このブロックに最初の4小節分のブロックをつないでみましょう。連続したブロックのかたまりのあるブロックを選んでドラッグするとそのブロックから下のつながったブロック全体を移動できます。そこで、まず5小節目の始まりのブロック(15番目の「(67)の音符を(1)拍鳴らす」)以下を下にドラッグして切り離します。次に、最初の音符(「(60)の音符を(1)拍鳴らす」)を同様にドラッグして「きらきら4」定義ブロックにつなぎます。
次に、ブロックエリアで「定義ブロック」をクリックします。すると、先ほど定義した「きらきら4」が現れているのに気づくと思います。このブロックをクリックしてみましょう。すると、最初の4小節分が演奏されるはずです。正しく演奏されることを確認できたら、このブロックを「緑の旗が押されたとき」あるいは「このスプライトが押されたとき」から始まるブロックのかたまりにつないでからイベントを送ってみます。先ほどブロック自体をクリックしたときと同じように最初の4小節が演奏されます。

次に同じように、定義ブロックとして「まばたき2」を定義します。この定義ブロックに先ほど切り離した「()の音符を()拍鳴らす」ブロックのかたまりから5, 6小節目を切り出して繋ぎましょう。

イベントブロックに演奏順に定義ブロックを繋げましょう。(メイン)プログラムは、以下のようにすっきりしました。「緑の旗」をクリックして全曲が演奏されることを確かめましょう。

イベントブロック
楽器を((1)ピアノ)にする
テンポ
きらきら4
まばたき2
まばたき2
きらきら4

このように定義ブロックを使うとやろうとしていることをわかりやすく書けます。
今回のように繰り返しの多い場合には、使用ブロック数も45から30へとだいぶ減りました。

### 移調できるプログラム
この「きらきら星」はハ長調(C dur)で演奏されます。これを、例えば、ト長調で演奏するにはどうすれば良いでしょうか?
ハ長調のきらきら星はド(C、ハ)から始まってドドソソララソ・・・(60, 60, 67, 67, 69, 69, 67, ...)と続くのに対してト長調だとソ(G、ト)から始まりソソレレミミレ・・・(67, 67, 74, 74, 76, 76, 74, ...)です。このように全体に平行移動することを移調と呼びます。これらの調は、主音と呼ばれる音で代表されます。ハ長調ならハ(ド, C, 60)が主音です。ト長調に移調するには、ハとト(ソ, G, 67)の違い分、すべての音符を移動させれば良いわけですね。

これを先ほどのプログラムで実現するためにはどうすれば良いでしょうか?
何も考えなければもう一回ト長調で全部打ち込み直すという手もあります・・・。でも、せっかくハ長調の演奏プログラムがあるので、これを使いたいですよね。

#### 変数による抽象化
まず、プログラムをもう一回よく見てみましょう。このプログラムではハ長調しか演奏できませんが、それはなぜでしょうか?
それは、「(60)の音符を(1)拍鳴らす」ブロックは60(ハ、ド、C)の音符しか鳴らせないし、「(67)の音符を(1)拍鳴らす」ブロックは67(ト、ソ、G)の音符しか鳴らせないからです。もし、「(x)の音符を(1)拍鳴らす」というブロックがあるとすれば、xを60や64、67に変えることで好きな調で演奏できそうですね。このxのように中身を変えられる記号を変数と呼びます。Scratchには変数ブロックが用意されているので、xという変数を作って、「(60)の音符を(1)拍鳴らす」ブロックの60が入っている個所にはめればOKです。

ただ、これだけだと他の音符もみな同じことをやるためにはx以外にもyやzやaや・・・と使う音符の数分の変数が必要です。もう少し考えてみましょう。どうすれば良いかわかりますか?

ここでは、主音に注目してみます。すべての他の音は主音からの相対的な位置で決められます。たとえば、ハ長調の場合、

| き | ら | き | ら | ひ | か | る |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| ド | ド | ソ | ソ | ラ | ラ | ソ |
| 60 | 60 | 67 | 67 | 69 | 69 | 67 |

なので、主音の60からどのくらい離れているかに置き換えると、ソ 67は主音60 + 7なので、7と表せます。同じようにラなら9などなどと表すようにすると以下の表の一番下の段のように書けます。

| き | ら | き | ら | ひ | か | る |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| ド | ド | ソ | ソ | ラ | ラ | ソ |
| 0 | 0 | 7 | 7 | 9 | 9 | 7 |

一方のト長調でも同じように主音からどのくらい離れているかで書くと(一番下の段を見てください)

| き | ら | き | ら | ひ | か | る |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| ソ | ソ | レ | レ | ミ | ミ | レ |
| 67 | 67 | 74 | 74 | 76 | 76 | 74 |
| 0 | 0 | 7 | 7 | 9 | 9 | 7 |

とハ長調とまったく同じです(当たり前といわないでくださいね。)。

つまり、「主音」 + 「主音との差」で各音符をあらわしておけば、主音を変えるだけで移調できそうです。ということは、変数は主音1つだけで済みそうです。

方針が立ったので早速先ほどのプログラムで移調できるようにしてみましょう。

Scratchでは、ブロック定義の一つ上にある変数というカテゴリで変数を作って使うことができます。
「変数」をクリックしてみましょう。
「変数を作る」というボタンをクリックすると、下の図に示すようなダイアログボックスが開いて、変数を作れます(変数を定義するとも言います)。ここでは、主音の英語であるtonicという名前の変数を定義したいので「新しい変数名」に _tonic と入力します。

その下の「すべてのスプライト用」「このスプライトのみ」では、「このスプライトのみ」を選んでおいてください。この点(変数のスコープ)については、後で説明します。

もしあなたがScratchのアカウントを作っていれば「クラウド変数(サーバに保存)」と表示されているかもしれません。クラウド変数はゲームの最高点などを記録するときに使う変数なので、ここではチェックしなくて良いです。

OKボタンを押すと、元の画面に戻り、「変数をつくる」ボタンの下に
_tonic
という変数が出来ているのがわかると思います。

これをもちいて、各「()の音符を()拍鳴らす」ブロックを書き換えます。早速プログラムを整理しておいたご利益がありました。整理後でも多くて大変ですが。

足し算は変数カテゴリの一つ上の「演算」カテゴリをクリックして「() + ()」ブロックを使います。このブロックをコードエリアにドラッグ&ドロップして左側の()に _tonic ブロックをはめます。右側の()には主音との差を入力しますが、その前にこのブロックを複製しておきます。「() + ()」ブロック上で右クリックすると、メニューが開くので一番上の「複製」を選びます。複製できたらそのうちの1つを「(60)の音符を(1)拍鳴らす」ブロックの60のところにドラッグしてはめてみましょう。このブロックの60はハ長調の主音60と主音との差0に分解できるので、「(_tonic) + ()」ブロックの()には0を入力します。
同じように、他のブロックも主音 + 主音との差の形式に変えましょう。

さて、演奏してみましょう。
あれっ、うまく演奏できませんね。どうしたのでしょう?考えてみてください。

答えをいってしまうと、変数 _tonic に主音の値を入れ忘れていたのでした。ブロックパレットの_tonic の左にある□にはチェックが入っていますね。このチェックはその変数の値を実行画面に表示するためのものです。実行画面の _tonic は0なので、
0, 0, 7, 7, 9, 9, 7, ...という差だけで演奏しようとして音が鳴らなかったわけです(もしかしたらとても低い音が鳴っているのかもしれませんが、私には聞こえません)。

_tonic に値を入れましょう。
このためには、変数カテゴリの
「[_tonic v]を(0)にする」ブロックをメインプログラムの「きらきら4」ブロックの上に挿入して、(0)をクリックしてから60と入力します。
この状態でイベントを送って演奏してみましょう。今度は無事に演奏されましたね。

では、 _tonic 60を67に変えてみてから、もう一回イベントを送ってみましょう。先ほどより高い音で「きらきら星」が演奏されれば移調成功です!

ただし、このプログラムでは、移調するにはプログラムに直接書かなければならないので、ユーザーが自分で主音を指定できるようにしましょう。
調べるカテゴリの「(あなたの名前は何ですか?)と聞いて待つ」ブロックをクリックしてみましょう。すると、実行画面に下図のように「あなたの名前は何ですか?」とユーザーの入力を待つダイアログボックスが表示されます。たとえば、 benkei_crab と入力してEnterキーを押すと、入力を受け付けてボックスが消えます。この受け付けられた入力は、ブロックパレットの「()と聞いて待つ」ブロックのすぐ下の「答え」という変数に入ります。試しに「答え」ブロックをクリックしてみてください。吹き出しで値が表示されます。benkei_crab (あなたが入力した値)であることを確認できましたか?

これらのブロックの使い方がわかったところで、プログラムに組み込んでみましょう。「緑の旗」(あるいは「このスプライトが押されたとき」から始めることにしたのなら、画面上のネコ)をクリックすると先ほどの
「あなたの名前は何ですか?」というダイアログボックスが表示されます。ここでは、(あなたの名前は何ですか?)を「主音は何ですか?」と書き換えましょう。もう一回同じように「緑の旗」でプログラムを実行してみると今度は「主音は何ですか?」と聞かれましたね。

でも、今はまだ「答え」を使えるようにしていませんので、次は答えの値を主音用の変数である _tonic に入れる必要があります。
このために すぐ下の「(_tonic)を(60)にする」の(60)に「答え」をはめましょう。
このブロックは、「(_tonic)を(答え)にする」と変わったはずです。
これでユーザーの入力にしたがって移調できるプログラムができ上がりました。
(ただし、主音を聞かれたときに、主音として想定していない値、例えば「a」などの数字以外や数字でも10000や-5のように音符として意味の無い値を入力された場合は対応できません。これらの妥当ではない値をユーザーが入力した場合にはどうすれば良いでしょうか?これは宿題とします。)

次回は、さらに調を変えられるようにプログラムを改良してみましょう。


